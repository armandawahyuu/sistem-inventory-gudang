// prisma/schema.prisma
// Sistem Inventory Gudang Sparepart Alat Berat

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER & AUTH ====================

model User {
  id                  String    @id @default(cuid())
  username            String    @unique
  password            String    // hashed with bcrypt (cost 12)
  name                String
  role                String    @default("supervisor") // admin, supervisor, staff
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  sessions Session[]

  @@index([username])
}

// Session untuk database-backed sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
}

// Token blacklist untuk logout
model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}

// Login attempts log
model LoginAttempt {
  id        String   @id @default(cuid())
  username  String
  ipAddress String
  userAgent String?
  success   Boolean
  createdAt DateTime @default(now())

  @@index([username])
  @@index([ipAddress])
  @@index([createdAt])
}

// Audit Trail - append-only log for all CRUD activities
model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  userName    String?  // Denormalized for quick access
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, EXPORT, IMPORT
  tableName   String
  recordId    String?
  dataBefore  Json?
  dataAfter   Json?
  ipAddress   String?
  userAgent   String?
  description String?  // Human-readable description
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([tableName])
  @@index([action])
  @@index([createdAt])
  @@index([recordId])
}

// Security Event Log - for security monitoring and alerting
model SecurityLog {
  id          String   @id @default(cuid())
  eventType   String   // LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, PASSWORD_CHANGE, RATE_LIMIT_HIT, etc
  userId      String?
  userName    String?
  ipAddress   String
  userAgent   String?
  details     Json?    // Additional event details
  riskLevel   String   @default("low") // low, medium, high, critical
  duration    Int?     // Request duration in ms
  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([riskLevel])
}

// ==================== MASTER DATA ====================



// Alat Berat
model HeavyEquipment {
  id        String   @id @default(cuid())
  code      String   @unique // Nomor unit
  name      String
  type      String   // Excavator, Bulldozer, Wheel Loader, dll
  brand     String
  model     String
  year      Int?
  site      String?  // Lokasi project
  status    String   @default("active") // active, maintenance, inactive
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockOuts StockOut[]

  @@index([type])
  @@index([site])
  @@index([status])
}

// Kategori Sparepart
model Category {
  id         String      @id @default(cuid())
  name       String      @unique
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  
  spareparts Sparepart[]
}

// Sparepart
model Sparepart {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  categoryId   String
  brand        String?
  unit         String   // pcs, liter, set, dll
  minStock     Int      @default(0)
  currentStock Int      @default(0)
  rackLocation String?  // Lokasi rak di gudang
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category          Category                 @relation(fields: [categoryId], references: [id])
  stockIns          StockIn[]
  stockOuts         StockOut[]
  compatibilities   EquipmentCompatibility[]
  warranties        Warranty[]
  stockOpnameItems  StockOpnameItem[]

  @@index([name])
  @@index([categoryId])
  @@index([code])
}

// Kompatibilitas Sparepart dengan Alat Berat
model EquipmentCompatibility {
  id             String  @id @default(cuid())
  sparepartId    String
  equipmentType  String  // Tipe alat yang kompatibel
  equipmentBrand String?
  equipmentModel String?

  sparepart Sparepart @relation(fields: [sparepartId], references: [id], onDelete: Cascade)

  @@index([sparepartId])
  @@index([equipmentType])
}

// Supplier
model Supplier {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockIns StockIn[]
}

// ==================== KARYAWAN & ABSENSI ====================

// Karyawan
model Employee {
  id         String   @id @default(cuid())
  nik        String   @unique // Nomor Induk Karyawan
  name       String
  position   String   // Mekanik, Staff Gudang, dll
  department String?
  phone      String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  attendances Attendance[]
  stockOuts   StockOut[]

  @@index([name])
  @@index([position])
}

// Absensi / Tarikan Finger
model Attendance {
  id            String    @id @default(cuid())
  employeeId    String
  date          DateTime  @db.Date
  clockIn       DateTime?
  clockOut      DateTime?
  status        String    @default("present") // present, absent, late, permit, sick
  overtimeHours Float?    @default(0)
  notes         String?
  createdAt     DateTime  @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([date])
  @@index([status])
}

// ==================== TRANSAKSI ====================

// Barang Masuk
model StockIn {
  id             String    @id @default(cuid())
  sparepartId    String
  quantity       Int
  supplierId     String?
  invoiceNumber  String?   // Nomor invoice/surat jalan
  purchasePrice  Float?    // Harga beli per unit
  warrantyExpiry DateTime? // Tanggal expired garansi
  notes          String?
  createdAt      DateTime  @default(now())

  sparepart Sparepart  @relation(fields: [sparepartId], references: [id])
  supplier  Supplier?  @relation(fields: [supplierId], references: [id])
  warranty  Warranty?

  @@index([sparepartId])
  @@index([supplierId])
  @@index([createdAt])
}

// Barang Keluar
model StockOut {
  id             String    @id @default(cuid())
  sparepartId    String
  equipmentId    String?   // Nullable untuk penyesuaian opname
  employeeId     String?   // Nullable untuk penyesuaian opname
  quantity       Int
  purpose        String?   // Keperluan: maintenance rutin, perbaikan, penyesuaian opname
  status         String    @default("pending") // pending, approved, rejected
  approvedAt     DateTime?
  approvedBy     String?   // User ID yang approve
  rejectedReason String?
  scannedBarcode String?   // Log barcode yang di-scan
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  sparepart Sparepart      @relation(fields: [sparepartId], references: [id])
  equipment HeavyEquipment? @relation(fields: [equipmentId], references: [id])
  employee  Employee?       @relation(fields: [employeeId], references: [id])

  @@index([sparepartId])
  @@index([equipmentId])
  @@index([employeeId])
  @@index([status])
  @@index([createdAt])
}

// ==================== KAS KECIL ====================

// Kategori Kas Kecil
model PettyCashCategory {
  id        String      @id @default(cuid())
  name      String      @unique // BBM, Makan, ATK, Transport, dll
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  transactions PettyCash[]
}

// Transaksi Kas Kecil
model PettyCash {
  id          String    @id @default(cuid())
  date        DateTime  @db.Date
  type        String    // in (pemasukan), out (pengeluaran)
  categoryId  String?
  amount      Float
  description String
  receipt     String?   // URL/path foto struk
  createdAt   DateTime  @default(now())

  category PettyCashCategory? @relation(fields: [categoryId], references: [id])

  @@index([date])
  @@index([type])
  @@index([categoryId])
}

// ==================== GARANSI ====================

// Tracking Garansi
model Warranty {
  id          String    @id @default(cuid())
  stockInId   String    @unique
  sparepartId String
  expiryDate  DateTime
  claimStatus String    @default("active") // active, claimed, expired
  claimDate   DateTime?
  claimNotes  String?
  createdAt   DateTime  @default(now())

  stockIn   StockIn   @relation(fields: [stockInId], references: [id], onDelete: Cascade)
  sparepart Sparepart @relation(fields: [sparepartId], references: [id])

  @@index([expiryDate])
  @@index([claimStatus])
  @@index([sparepartId])
}

// ==================== IMPORT LOG ====================

// Log Hasil Import
model ImportLog {
  id          String   @id @default(cuid())
  type        String   // kategori, supplier, alat-berat, sparepart, karyawan, stok-awal
  filename    String?  // Nama file yang diimport
  totalRows   Int      @default(0)
  successRows Int      @default(0)
  failedRows  Int      @default(0)
  skippedRows Int      @default(0)
  errors      Json?    // Array of { row, message }
  createdAt   DateTime @default(now())
  createdBy   String?  // User ID yang melakukan import

  @@index([type])
  @@index([createdAt])
}

// ==================== STOK OPNAME ====================

// Header Stok Opname
model StockOpname {
  id          String   @id @default(cuid())
  opnameDate  DateTime @default(now())
  notes       String?
  status      String   @default("DRAFT") // DRAFT, COMPLETED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  items       StockOpnameItem[]

  @@index([opnameDate])
  @@index([status])
}

// Detail Item Stok Opname
model StockOpnameItem {
  id            String   @id @default(cuid())
  opnameId      String
  sparepartId   String
  systemStock   Int      // Stok sistem saat opname
  physicalStock Int      // Stok fisik hasil hitung
  difference    Int      // Selisih (fisik - sistem)
  notes         String?
  createdAt     DateTime @default(now())

  opname        StockOpname @relation(fields: [opnameId], references: [id], onDelete: Cascade)
  sparepart     Sparepart   @relation(fields: [sparepartId], references: [id])

  @@index([opnameId])
  @@index([sparepartId])
}

// ==================== CLEANUP LOG ====================

// Log hasil cleanup
model CleanupLog {
  id          String   @id @default(cuid())
  action      String   // duplicates, empty, standardize, references
  type        String?  // sparepart, alat-berat, karyawan, etc.
  description String
  affectedCount Int    @default(0)
  details     Json?    // Detail items yang di-cleanup
  createdAt   DateTime @default(now())
  createdBy   String?

  @@index([action])
  @@index([createdAt])
}
